<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KIRI â€” Pipeline Trace</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#06070a;--s1:#0c0d12;--s2:#12131a;--bdr:#1a1c24;
  --tx:#d8d5cf;--dim:#555566;--g:#4ade80;--a:#fbbf24;--r:#f87171;
  --b:#60a5fa;--p:#c084fc;--c:#22d3ee;
  --mono:'JetBrains Mono',monospace;--hd:'Fraunces',serif;
}
:root.light {
  --bg:#f8f8f6;--s1:#ffffff;--s2:#f0f0ec;--bdr:#d8d8d0;
  --tx:#1a1a1a;--dim:#666670;--g:#16a34a;--a:#b45309;--r:#dc2626;
  --b:#2563eb;--p:#7c3aed;--c:#0891b2;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:var(--mono);font-size:13px;line-height:1.75}
.w{max-width:1120px;margin:0 auto;padding:48px 24px 120px}

/* Nav */
.nav{display:flex;gap:0;border-bottom:1px solid var(--bdr);margin-bottom:36px;overflow-x:auto;position:sticky;top:0;background:var(--bg);z-index:10;padding-top:8px;align-items:center}
.nav a{background:none;border:none;color:var(--dim);font-family:var(--mono);font-size:11px;padding:10px 16px;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .2s;letter-spacing:.5px;text-decoration:none;display:block}
.nav a:hover{color:var(--tx)}
.nav a.on{color:var(--g);border-bottom-color:var(--g)}
.theme-toggle{margin-left:auto;background:none;border:1px solid var(--bdr);color:var(--dim);font-family:var(--mono);font-size:11px;padding:5px 12px;cursor:pointer;border-radius:100px;transition:all .2s;flex-shrink:0}
.theme-toggle:hover{color:var(--tx);border-color:var(--dim)}

/* Hero */
.hero{padding:40px 0 32px;position:relative}
.hero::before{content:'';position:absolute;top:0;left:-200px;width:700px;height:700px;background:radial-gradient(ellipse,rgba(74,222,128,0.03)0%,transparent 60%);pointer-events:none}
:root.light .hero::before{background:radial-gradient(ellipse,rgba(22,163,74,0.06)0%,transparent 60%)}
.ey{font-size:10px;color:var(--g);letter-spacing:4px;text-transform:uppercase;margin-bottom:12px}
h1{font-family:var(--hd);font-size:42px;font-weight:500;line-height:1.1;letter-spacing:-1px;margin-bottom:8px}
h1 em{font-style:italic;color:var(--g)}
.lead{color:var(--dim);font-size:13px;font-weight:300;max-width:700px;line-height:1.8}
.lead strong{color:var(--tx);font-weight:500}

/* Controls */
.controls{display:flex;gap:8px;align-items:center;margin:24px 0;flex-wrap:wrap}
.btn{background:var(--s1);border:1px solid var(--bdr);color:var(--tx);font-family:var(--mono);font-size:11px;padding:7px 18px;cursor:pointer;border-radius:3px;transition:all .15s;letter-spacing:.5px}
.btn:hover{border-color:var(--g);color:var(--g)}
.btn.active{background:var(--g);color:var(--bg);border-color:var(--g)}
.btn:disabled{opacity:.3;cursor:not-allowed}
.ctrl-info{font-size:10px;color:var(--dim);margin-left:8px}

/* Pipeline */
.pipeline{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin:0 0 48px}
@media(max-width:900px){.pipeline{grid-template-columns:repeat(3,1fr)}}
@media(max-width:560px){.pipeline{grid-template-columns:1fr}}

.stage{background:var(--s1);border:1px solid var(--bdr);border-radius:3px;padding:16px;position:relative;overflow:hidden;transition:all .4s ease;opacity:.35;transform:translateY(4px)}
.stage::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:3px 3px 0 0;transition:opacity .4s}
.stage.active{opacity:1;transform:translateY(0)}
.stage.done{opacity:.7;transform:translateY(0)}
.stage.active::after{content:'';position:absolute;inset:0;border:1px solid;border-radius:3px;pointer-events:none;animation:glow 1.5s ease infinite}
@keyframes glow{0%,100%{opacity:.3}50%{opacity:.8}}

.s-observe::before,.s-observe.active::after{border-color:var(--g);background:var(--g)}
.s-quantize::before,.s-quantize.active::after{border-color:var(--b);background:var(--b)}
.s-encode::before,.s-encode.active::after{border-color:var(--p);background:var(--p)}
.s-attend::before,.s-attend.active::after{border-color:var(--a);background:var(--a)}
.s-score::before,.s-score.active::after{border-color:var(--c);background:var(--c)}
.s-verdict::before,.s-verdict.active::after{border-color:var(--r);background:var(--r)}

.stage-num{font-size:9px;color:var(--dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.stage-title{font-size:14px;font-weight:500;margin-bottom:8px}
.s-observe .stage-title{color:var(--g)}
.s-quantize .stage-title{color:var(--b)}
.s-encode .stage-title{color:var(--p)}
.s-attend .stage-title{color:var(--a)}
.s-score .stage-title{color:var(--c)}
.s-verdict .stage-title{color:var(--r)}
.stage-body{font-size:10px;color:var(--dim);line-height:1.7;min-height:140px}

/* Observe: metric bars */
.metric{display:flex;align-items:center;gap:6px;margin:3px 0}
.metric-lbl{width:52px;font-size:9px;color:var(--dim);text-align:right}
.metric-bar{flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.metric-fill{height:100%;border-radius:3px;background:var(--g);transition:width .6s ease}
.metric-val{width:32px;font-size:9px;color:var(--tx);text-align:right;font-variant-numeric:tabular-nums}

/* Quantize: bucket display */
.bucket-row{margin:4px 0}
.bucket-lbl{font-size:9px;color:var(--dim);margin-bottom:2px}
.buckets{display:flex;gap:1px}
.bkt{flex:1;height:14px;background:var(--bg);border:1px solid var(--bdr);font-size:7px;display:flex;align-items:center;justify-content:center;color:var(--dim);border-radius:1px;transition:all .3s}
.bkt.hit{background:var(--b);color:var(--bg);border-color:var(--b);font-weight:700}

/* Encode: token sequence */
.tok-seq{display:flex;flex-wrap:wrap;gap:3px;margin:6px 0}
.tok{padding:3px 6px;border-radius:2px;font-size:10px;font-weight:500;border:1px solid var(--bdr);background:var(--bg);transition:all .3s}
.tok.t-bos{color:var(--dim);border-color:var(--dim)}
.tok.t-C{color:var(--g);border-color:var(--g)}
.tok.t-M{color:var(--b);border-color:var(--b)}
.tok.t-D{color:var(--a);border-color:var(--a)}
.tok.t-S{color:var(--p);border-color:var(--p)}
.tok.t-L{color:var(--c);border-color:var(--c)}
.tok.t-N{color:var(--r);border-color:var(--r)}
.tok-id{font-size:8px;color:var(--dim);text-align:center;margin-top:1px}

/* Attend: attention viz */
.attn-info{font-size:9px;color:var(--dim);margin:4px 0;line-height:1.6}
.attn-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin:6px 0}
.attn-cell{aspect-ratio:1;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:7px;color:var(--bg);transition:all .4s}
.code-ref{font-size:9px;color:var(--a);font-style:italic;margin-top:4px;word-break:break-all}

/* Score: probability bars */
.score-row{display:flex;align-items:center;gap:4px;margin:3px 0;font-size:9px}
.score-tok{width:20px;font-weight:500}
.score-bar{flex:1;height:5px;background:var(--bg);border-radius:3px;overflow:hidden}
.score-fill{height:100%;border-radius:3px;transition:width .4s}
.score-val{width:40px;text-align:right;font-variant-numeric:tabular-nums;font-size:8px}

/* Score comparison */
.score-compare{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
.sc-box{background:var(--bg);border:1px solid var(--bdr);border-radius:3px;padding:8px;text-align:center}
.sc-label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.sc-score{font-size:18px;font-weight:700;font-family:var(--hd)}
.sc-score.normal{color:var(--g)}
.sc-score.anomalous{color:var(--r)}

/* Verdict */
.verdict-box{text-align:center;padding:12px 0}
.verdict-icon{font-size:32px;margin-bottom:4px}
.verdict-score{font-size:20px;font-weight:700;font-family:var(--hd)}
.verdict-msg{font-size:11px;margin-top:4px}
.verdict-toggle{margin-top:10px}
.verdict-toggle button{background:none;border:1px solid var(--bdr);color:var(--dim);font-family:var(--mono);font-size:9px;padding:3px 10px;cursor:pointer;border-radius:100px;transition:all .15s;margin:0 2px}
.verdict-toggle button:hover{color:var(--tx);border-color:var(--dim)}
.verdict-toggle button.active{border-color:var(--g);color:var(--g)}

/* Arrow connectors (desktop only) */
.arrow-row{display:flex;align-items:center;justify-content:center;margin:-6px 0;pointer-events:none}
@media(max-width:900px){.arrow-row{display:none}}
.arrow-seg{flex:1;display:flex;align-items:center;justify-content:center;height:20px;position:relative}
.arrow-seg::after{content:'';width:60%;height:1px;background:var(--bdr)}
.arrow-seg .arr{position:absolute;right:18%;color:var(--dim);font-size:10px}

/* Code block */
.code{background:var(--s1);border:1px solid var(--bdr);padding:20px;margin:32px 0;border-radius:3px;overflow-x:auto;font-size:12px;line-height:1.9}
:root.light .code{background:#f0f0ec}
.code pre{font-family:var(--mono)}
.code .cm{color:var(--dim)}
.code .fn{color:var(--g)}
.code .kw{color:var(--p)}
.code .st{color:var(--a)}
.code .op{color:var(--b)}
.code-title{font-size:11px;color:var(--g);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;font-weight:500}

/* Footer */
.foot{margin-top:80px;padding-top:20px;border-top:1px solid var(--bdr);text-align:center;color:var(--dim);font-size:10px}
.foot a{color:var(--g);text-decoration:none}
.foot a:hover{text-decoration:underline}

@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="w">

<div class="nav">
  <a href="index.html">explainer</a>
  <a href="live.html">live pass</a>
  <a href="params.html">params 3D</a>
  <a class="on" href="trace.html">pipeline trace</a>
  <button class="theme-toggle" id="themeToggle">light</button>
</div>

<div class="hero">
  <div class="ey">pipeline trace visualization</div>
  <h1>Data through the <em>Atom</em></h1>
  <p class="lead">
    Follow one observation from <strong>raw Mac metrics</strong> through quantization, token encoding, transformer attention, anomaly scoring, to final verdict. Six stages. One pipe. The complete KIRI pipeline in motion.
  </p>
</div>

<div class="controls">
  <button class="btn" id="btn-step">Step</button>
  <button class="btn" id="btn-play">Auto Play</button>
  <button class="btn" id="btn-replay">Replay</button>
  <button class="btn" id="btn-toggle-anomaly">Show Anomaly</button>
  <span class="ctrl-info" id="ctrl-info">Press Step or Auto Play to begin</span>
</div>

<div class="pipeline" id="pipeline">

  <!-- Stage 1: OBSERVE -->
  <div class="stage s-observe" id="stage-0">
    <div class="stage-num">stage 1</div>
    <div class="stage-title">OBSERVE</div>
    <div class="stage-body" id="body-0">
      <div class="metric"><span class="metric-lbl">CPU</span><div class="metric-bar"><div class="metric-fill" id="bar-cpu" style="width:0%"></div></div><span class="metric-val" id="val-cpu">--</span></div>
      <div class="metric"><span class="metric-lbl">Memory</span><div class="metric-bar"><div class="metric-fill" id="bar-mem" style="width:0%"></div></div><span class="metric-val" id="val-mem">--</span></div>
      <div class="metric"><span class="metric-lbl">Disk</span><div class="metric-bar"><div class="metric-fill" id="bar-disk" style="width:0%"></div></div><span class="metric-val" id="val-disk">--</span></div>
      <div class="metric"><span class="metric-lbl">Swap</span><div class="metric-bar"><div class="metric-fill" id="bar-swap" style="width:0%"></div></div><span class="metric-val" id="val-swap">--</span></div>
      <div class="metric"><span class="metric-lbl">Load</span><div class="metric-bar"><div class="metric-fill" id="bar-load" style="width:0%"></div></div><span class="metric-val" id="val-load">--</span></div>
      <div class="metric"><span class="metric-lbl">Network</span><div class="metric-bar"><div class="metric-fill" id="bar-net" style="width:0%"></div></div><span class="metric-val" id="val-net">--</span></div>
    </div>
  </div>

  <!-- Stage 2: QUANTIZE -->
  <div class="stage s-quantize" id="stage-1">
    <div class="stage-num">stage 2</div>
    <div class="stage-title">QUANTIZE</div>
    <div class="stage-body" id="body-1"></div>
  </div>

  <!-- Stage 3: ENCODE -->
  <div class="stage s-encode" id="stage-2">
    <div class="stage-num">stage 3</div>
    <div class="stage-title">ENCODE</div>
    <div class="stage-body" id="body-2"></div>
  </div>

  <!-- Stage 4: ATTEND -->
  <div class="stage s-attend" id="stage-3">
    <div class="stage-num">stage 4</div>
    <div class="stage-title">ATTEND</div>
    <div class="stage-body" id="body-3"></div>
  </div>

  <!-- Stage 5: SCORE -->
  <div class="stage s-score" id="stage-4">
    <div class="stage-num">stage 5</div>
    <div class="stage-title">SCORE</div>
    <div class="stage-body" id="body-4"></div>
  </div>

  <!-- Stage 6: VERDICT -->
  <div class="stage s-verdict" id="stage-5">
    <div class="stage-num">stage 6</div>
    <div class="stage-title">VERDICT</div>
    <div class="stage-body" id="body-5"></div>
  </div>

</div>

<!-- Code context -->
<div class="code">
  <div class="code-title">The complete pipeline in atom.py</div>
  <pre><span class="cm"># The complete pipeline in ~10 lines</span>
<span class="fn">obs</span> <span class="op">=</span> collect_local()           <span class="cm"># OBSERVE</span>
<span class="fn">tokens</span> <span class="op">=</span> lang.encode(obs)       <span class="cm"># QUANTIZE + ENCODE</span>
<span class="kw">for</span> tok <span class="kw">in</span> tokens:              <span class="cm"># ATTEND</span>
    logits <span class="op">=</span> atom.forward(tok, pos, keys, vals)
<span class="fn">prob</span> <span class="op">=</span> atom._softmax(logits)    <span class="cm"># SCORE</span>
<span class="fn">score</span> <span class="op">=</span> -log(prob[actual])      <span class="cm"># VERDICT</span></pre>
</div>

<div class="foot">
  KIRI &mdash; Intelligent Runtime Inspector<br>
  Built on <a href="https://gist.github.com/karpathy/8627fe009c40f57531cb18360106ce95">Karpathy's microgpt</a> &middot; Open Source &middot; 2026
</div>

</div>

<script>
// ============================================================
// DATA: Two scenarios
// ============================================================

const scenarios = {
  normal: {
    label: 'Normal',
    raw: { cpu: 19, mem: 73, disk: 46, swap: 85, load: 1.94, net: 1 },
    buckets: { C: 1, M: 7, D: 4, S: 4, L: 0, N: 1 },
    tokens: ['BOS','C1','M7','D4','S4','L0','N1'],
    tokenIds: [0, 2, 18, 25, 35, 36, 42],
    attnWeights: [
      [0.05, 0.08, 0.35, 0.15, 0.12, 0.10, 0.15],
      [0.03, 0.04, 0.10, 0.22, 0.18, 0.28, 0.15],
      [0.12, 0.06, 0.09, 0.11, 0.30, 0.14, 0.18],
      [0.02, 0.15, 0.20, 0.08, 0.10, 0.25, 0.20],
      [0.08, 0.10, 0.14, 0.16, 0.12, 0.18, 0.22],
      [0.04, 0.06, 0.12, 0.20, 0.15, 0.23, 0.20],
      [0.10, 0.10, 0.15, 0.15, 0.15, 0.15, 0.20],
    ],
    perToken: [
      { tok: 'C1', pred: 0.68, score: 0.39 },
      { tok: 'M7', pred: 0.55, score: 0.60 },
      { tok: 'D4', pred: 0.61, score: 0.49 },
      { tok: 'S4', pred: 0.42, score: 0.87 },
      { tok: 'L0', pred: 0.73, score: 0.31 },
      { tok: 'N1', pred: 0.89, score: 0.12 },
    ],
    avgScore: 0.72,
    verdict: { icon: '\u2713', msg: 'All clear', color: 'var(--g)' },
  },
  anomaly: {
    label: 'Anomalous',
    raw: { cpu: 97, mem: 94, disk: 46, swap: 98, load: 18.7, net: 1 },
    buckets: { C: 9, M: 9, D: 4, S: 4, L: 4, N: 1 },
    tokens: ['BOS','C9','M9','D4','S4','L4','N1'],
    tokenIds: [0, 10, 20, 25, 35, 40, 42],
    attnWeights: [
      [0.14, 0.14, 0.14, 0.14, 0.14, 0.14, 0.16],
      [0.02, 0.40, 0.30, 0.08, 0.05, 0.10, 0.05],
      [0.03, 0.25, 0.35, 0.12, 0.10, 0.08, 0.07],
      [0.05, 0.10, 0.12, 0.30, 0.20, 0.13, 0.10],
      [0.02, 0.30, 0.25, 0.10, 0.08, 0.15, 0.10],
      [0.08, 0.18, 0.20, 0.12, 0.15, 0.12, 0.15],
      [0.04, 0.22, 0.22, 0.10, 0.12, 0.15, 0.15],
    ],
    perToken: [
      { tok: 'C9', pred: 0.0001, score: 9.38 },
      { tok: 'M9', pred: 0.000005, score: 12.11 },
      { tok: 'D4', pred: 0.58, score: 0.54 },
      { tok: 'S4', pred: 0.0001, score: 9.19 },
      { tok: 'L4', pred: 0.0003, score: 8.11 },
      { tok: 'N1', pred: 0.82, score: 0.20 },
    ],
    avgScore: 7.98,
    verdict: { icon: '\u2716', msg: 'CPU spike at 3am', color: 'var(--r)' },
  }
};

const schema = {
  C: { label: 'CPU %', min: 0, max: 100, buckets: 10 },
  M: { label: 'Memory %', min: 0, max: 100, buckets: 10 },
  D: { label: 'Disk %', min: 0, max: 100, buckets: 10 },
  S: { label: 'Swap %', min: 0, max: 100, buckets: 5 },
  L: { label: 'Load avg', min: 0, max: 20, buckets: 5 },
  N: { label: 'Network', min: 0, max: 1, buckets: 2 },
};

// ============================================================
// STATE
// ============================================================

let currentStep = -1; // -1 = not started
let isPlaying = false;
let playTimer = null;
let currentScenario = 'normal';

function getScenario() { return scenarios[currentScenario]; }

// ============================================================
// RENDERING
// ============================================================

function renderObserve(sc) {
  const r = sc.raw;
  const items = [
    { id: 'cpu', val: r.cpu, pct: r.cpu, unit: '%' },
    { id: 'mem', val: r.mem, pct: r.mem, unit: '%' },
    { id: 'disk', val: r.disk, pct: r.disk, unit: '%' },
    { id: 'swap', val: r.swap, pct: r.swap, unit: '%' },
    { id: 'load', val: r.load, pct: (r.load / 20) * 100, unit: '' },
    { id: 'net', val: r.net ? 'UP' : 'DOWN', pct: r.net * 100, unit: '' },
  ];
  items.forEach(it => {
    const bar = document.getElementById('bar-' + it.id);
    const val = document.getElementById('val-' + it.id);
    bar.style.width = it.pct + '%';
    if (it.pct > 80) bar.style.background = 'var(--r)';
    else if (it.pct > 60) bar.style.background = 'var(--a)';
    else bar.style.background = 'var(--g)';
    val.textContent = typeof it.val === 'number' ? (it.val + it.unit) : it.val;
  });
}

function renderQuantize(sc) {
  const el = document.getElementById('body-1');
  let html = '';
  const prefixes = ['C','M','D','S','L','N'];
  const rawKeys = ['cpu','mem','disk','swap','load','net'];
  prefixes.forEach((pfx, i) => {
    const s = schema[pfx];
    const hit = sc.buckets[pfx];
    const rawVal = sc.raw[rawKeys[i]];
    html += '<div class="bucket-row">';
    html += '<div class="bucket-lbl">' + pfx + ' ' + (typeof rawVal === 'number' ? rawVal : (rawVal ? 'UP' : 'DOWN'));
    html += ' &rarr; bucket ' + hit + '</div>';
    html += '<div class="buckets">';
    for (let b = 0; b < s.buckets; b++) {
      const lo = s.min + (s.max - s.min) * b / s.buckets;
      const hi = s.min + (s.max - s.min) * (b + 1) / s.buckets;
      const label = Math.round(lo) + '-' + Math.round(hi);
      html += '<div class="bkt' + (b === hit ? ' hit' : '') + '" title="' + label + '">' + b + '</div>';
    }
    html += '</div></div>';
  });
  el.innerHTML = html;
}

function renderEncode(sc) {
  const el = document.getElementById('body-2');
  let html = '<div style="font-size:9px;color:var(--dim);margin-bottom:6px">Token sequence (BOS + 6 metric tokens):</div>';
  html += '<div class="tok-seq">';
  sc.tokens.forEach((tok, i) => {
    const pfx = tok === 'BOS' ? 'bos' : tok[0];
    html += '<div style="text-align:center">';
    html += '<div class="tok t-' + pfx + '">' + tok + '</div>';
    html += '<div class="tok-id">id ' + sc.tokenIds[i] + '</div>';
    html += '</div>';
    if (i < sc.tokens.length - 1) {
      html += '<div style="color:var(--dim);font-size:10px;display:flex;align-items:center;padding:0 1px">&rarr;</div>';
    }
  });
  html += '</div>';
  html += '<div style="font-size:9px;color:var(--dim);margin-top:8px">vocab_size = 43 (42 metric tokens + BOS)</div>';
  el.innerHTML = html;
}

function renderAttend(sc) {
  const el = document.getElementById('body-3');
  let html = '';
  html += '<div class="attn-info">Embedding: 32-dim &middot; 4 heads &middot; 2 layers<br>Simplified: final position attention weights</div>';
  // Attention heatmap for last token attending to all
  html += '<div style="font-size:9px;color:var(--dim);margin:4px 0">Attention from N1 (last) to all:</div>';
  html += '<div class="attn-grid">';
  const lastRow = sc.attnWeights[sc.attnWeights.length - 1];
  sc.tokens.forEach((tok, j) => {
    const w = lastRow[j];
    const alpha = Math.min(1, w * 3.5);
    const bg = currentScenario === 'normal'
      ? 'rgba(74,222,128,' + alpha + ')'
      : 'rgba(248,113,113,' + alpha + ')';
    html += '<div class="attn-cell" style="background:' + bg + ';font-size:8px;color:' + (alpha > 0.4 ? 'var(--bg)' : 'var(--dim)') + '">';
    html += tok + '<br>' + (w * 100).toFixed(0) + '%</div>';
  });
  html += '</div>';
  html += '<div class="code-ref">q = self._linear(x, sd[\'l0.wq\'])</div>';
  el.innerHTML = html;
}

function renderScore(sc) {
  const el = document.getElementById('body-4');
  let html = '<div style="font-size:9px;color:var(--dim);margin-bottom:6px">Score = -log(P(actual)) per token:</div>';
  const maxScore = Math.max(...sc.perToken.map(t => t.score));
  sc.perToken.forEach(t => {
    const pct = (t.score / Math.max(maxScore, 1)) * 100;
    const isHigh = t.score > 3;
    const color = isHigh ? 'var(--r)' : 'var(--g)';
    html += '<div class="score-row">';
    html += '<span class="score-tok" style="color:' + color + '">' + t.tok + '</span>';
    html += '<div class="score-bar"><div class="score-fill" style="width:' + pct + '%;background:' + color + '"></div></div>';
    html += '<span class="score-val" style="color:' + color + '">' + t.score.toFixed(2) + '</span>';
    html += '</div>';
  });
  html += '<div class="score-compare">';
  html += '<div class="sc-box"><div class="sc-label">Normal avg</div><div class="sc-score normal">0.72</div></div>';
  html += '<div class="sc-box"><div class="sc-label">Anomalous avg</div><div class="sc-score anomalous">7.98</div></div>';
  html += '</div>';
  el.innerHTML = html;
}

function renderVerdict(sc) {
  const el = document.getElementById('body-5');
  const v = sc.verdict;
  const isAnomaly = currentScenario === 'anomaly';
  let html = '<div class="verdict-box">';
  html += '<div class="verdict-icon" style="color:' + v.color + '">' + v.icon + '</div>';
  html += '<div class="verdict-score" style="color:' + v.color + '">' + sc.avgScore.toFixed(2) + '</div>';
  html += '<div class="verdict-msg" style="color:' + v.color + '">' + v.msg + '</div>';
  if (isAnomaly) {
    html += '<div style="font-size:9px;color:var(--dim);margin-top:8px">11x more surprising than normal.<br>C9, M9, S4 near-zero probability.</div>';
  } else {
    html += '<div style="font-size:9px;color:var(--dim);margin-top:8px">Model has seen this pattern<br>thousands of times. Expected.</div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

const stageRenderers = [renderObserve, renderQuantize, renderEncode, renderAttend, renderScore, renderVerdict];

function renderStage(idx) {
  const sc = getScenario();
  stageRenderers[idx](sc);
}

function updateStages() {
  for (let i = 0; i < 6; i++) {
    const el = document.getElementById('stage-' + i);
    el.classList.remove('active', 'done');
    if (i === currentStep) {
      el.classList.add('active');
      renderStage(i);
    } else if (i < currentStep) {
      el.classList.add('done');
    }
  }
  const info = document.getElementById('ctrl-info');
  if (currentStep < 0) {
    info.textContent = 'Press Step or Auto Play to begin';
  } else if (currentStep >= 5) {
    info.textContent = 'Pipeline complete (' + getScenario().label + ')';
  } else {
    const names = ['OBSERVE', 'QUANTIZE', 'ENCODE', 'ATTEND', 'SCORE', 'VERDICT'];
    info.textContent = 'Stage ' + (currentStep + 1) + '/6: ' + names[currentStep];
  }
}

// ============================================================
// CONTROLS
// ============================================================

function step() {
  if (currentStep < 5) {
    currentStep++;
    updateStages();
  } else {
    if (isPlaying) stopPlay();
  }
}

function startPlay() {
  isPlaying = true;
  document.getElementById('btn-play').classList.add('active');
  document.getElementById('btn-play').textContent = 'Pause';
  playTimer = setInterval(step, 2000);
}

function stopPlay() {
  isPlaying = false;
  document.getElementById('btn-play').classList.remove('active');
  document.getElementById('btn-play').textContent = 'Auto Play';
  clearInterval(playTimer);
  playTimer = null;
}

function replay() {
  stopPlay();
  currentStep = -1;
  // Reset observe bars
  ['cpu','mem','disk','swap','load','net'].forEach(id => {
    document.getElementById('bar-' + id).style.width = '0%';
    document.getElementById('val-' + id).textContent = '--';
  });
  // Clear stage bodies except observe
  for (let i = 1; i < 6; i++) {
    document.getElementById('body-' + i).innerHTML = '';
  }
  updateStages();
}

function toggleScenario() {
  const btn = document.getElementById('btn-toggle-anomaly');
  if (currentScenario === 'normal') {
    currentScenario = 'anomaly';
    btn.textContent = 'Show Normal';
    btn.classList.add('active');
  } else {
    currentScenario = 'normal';
    btn.textContent = 'Show Anomaly';
    btn.classList.remove('active');
  }
  // Re-render all visible stages
  for (let i = 0; i <= currentStep && i < 6; i++) {
    renderStage(i);
  }
  // Update info text
  const info = document.getElementById('ctrl-info');
  if (currentStep >= 5) {
    info.textContent = 'Pipeline complete (' + getScenario().label + ')';
  }
}

document.getElementById('btn-step').addEventListener('click', step);
document.getElementById('btn-play').addEventListener('click', function() {
  if (isPlaying) { stopPlay(); } else {
    if (currentStep >= 5) replay();
    startPlay();
  }
});
document.getElementById('btn-replay').addEventListener('click', replay);
document.getElementById('btn-toggle-anomaly').addEventListener('click', toggleScenario);

// ============================================================
// THEME TOGGLE
// ============================================================

const toggle = document.getElementById('themeToggle');
toggle.addEventListener('click', function() {
  document.documentElement.classList.toggle('light');
  var isLight = document.documentElement.classList.contains('light');
  toggle.textContent = isLight ? 'dark' : 'light';
  localStorage.setItem('kiri-theme', isLight ? 'light' : 'dark');
});
if (localStorage.getItem('kiri-theme') === 'light') {
  document.documentElement.classList.add('light');
  toggle.textContent = 'dark';
}

// ============================================================
// INIT
// ============================================================
updateStages();
</script>
</body>
</html>
