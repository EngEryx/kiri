<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KIRI — Parameter Architecture</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Fraunces:opsz,wght@9..144,400;9..144,600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<style>
:root{
  --bg:#06070a;--s1:#0c0d12;--s2:#13141a;--bdr:#1a1c24;
  --tx:#d8d5cf;--dim:#555566;--g:#4ade80;--a:#fbbf24;--r:#f87171;
  --b:#60a5fa;--p:#c084fc;--c:#22d3ee;
  --mono:'JetBrains Mono',monospace;--hd:'Fraunces',serif;
}
:root.light{
  --bg:#f8f8f6;--s1:#ffffff;--s2:#f0f0ec;--bdr:#d8d8d0;
  --tx:#1a1a1a;--dim:#666670;--g:#16a34a;--a:#b45309;--r:#dc2626;
  --b:#2563eb;--p:#7c3aed;--c:#0891b2;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:var(--mono);font-size:12px;line-height:1.6;overflow:hidden;height:100vh}
.app{display:grid;grid-template-rows:auto 1fr;height:100vh}
.topbar{display:flex;align-items:center;gap:12px;padding:10px 20px;border-bottom:1px solid var(--bdr);background:var(--s1);flex-wrap:wrap}
.topbar a{color:var(--g);text-decoration:none;font-size:11px}
.topbar a:hover{text-decoration:underline}
.topbar h1{font-family:var(--hd);font-size:16px;font-weight:400;flex:1}
.topbar h1 em{color:var(--g);font-style:italic}
.modes{display:flex;gap:4px}
.modes button{background:none;border:1px solid var(--bdr);color:var(--dim);font-family:var(--mono);font-size:10px;padding:4px 14px;cursor:pointer;border-radius:3px;transition:all .15s;letter-spacing:.5px}
.modes button:hover{color:var(--tx);border-color:var(--dim)}
.modes button.on{background:var(--g);color:var(--bg);border-color:var(--g)}
.tbtn{background:none;border:1px solid var(--bdr);color:var(--dim);font-family:var(--mono);font-size:10px;padding:4px 12px;cursor:pointer;border-radius:100px;transition:all .15s}
.tbtn:hover{color:var(--tx);border-color:var(--dim)}
.main{display:grid;grid-template-columns:1fr 320px;overflow:hidden}
@media(max-width:900px){.main{grid-template-columns:1fr;grid-template-rows:55vh 45vh}}
.canvas-wrap{position:relative;overflow:hidden}
canvas{width:100%;height:100%;display:block}
.legend{position:absolute;bottom:16px;left:16px;display:flex;gap:14px;font-size:9px;color:var(--dim);letter-spacing:.5px}
.lg{display:flex;align-items:center;gap:5px}
.dot{width:8px;height:8px;border-radius:2px}
.comp-ctrl{position:absolute;bottom:16px;right:16px;display:flex;gap:8px;align-items:center}
.comp-ctrl button{background:var(--s1);border:1px solid var(--bdr);color:var(--tx);font-family:var(--mono);font-size:10px;padding:4px 12px;cursor:pointer;border-radius:3px;transition:all .15s}
.comp-ctrl button:hover{border-color:var(--g);color:var(--g)}
.comp-ctrl button.on{background:var(--g);color:var(--bg);border-color:var(--g)}
.step-lbl{font-size:9px;color:var(--dim);max-width:200px;text-align:right}
.info{background:var(--s1);border-left:1px solid var(--bdr);overflow-y:auto;padding:20px}
@media(max-width:900px){.info{border-left:none;border-top:1px solid var(--bdr)}}
.info h3{font-size:11px;color:var(--g);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;font-weight:500}
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);border:1px solid var(--bdr);margin-bottom:16px}
.stat{background:var(--s2);padding:10px;text-align:center}
.stat .n{font-size:18px;font-weight:700;color:var(--g);font-family:var(--hd)}
.stat .l{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.dc{background:var(--s2);border:1px solid var(--bdr);border-radius:3px;padding:14px;margin-bottom:10px}
.dc-name{font-size:14px;font-weight:500;margin-bottom:4px}
.dc-shape{font-size:10px;color:var(--dim)}
.dc-purpose{font-size:10px;color:var(--dim);margin-top:6px;line-height:1.6}
.dc-bar{margin-top:8px}
.dc-bar-track{height:4px;background:var(--bg);border-radius:2px;overflow:hidden}
.dc-bar-fill{height:100%;border-radius:2px}
.dc-bar-lbl{font-size:9px;color:var(--dim);margin-top:3px;display:flex;justify-content:space-between}
.dc-code{margin-top:10px;background:var(--bg);border:1px solid var(--bdr);border-radius:3px;padding:8px 10px;font-size:10px;line-height:1.7;overflow-x:auto;white-space:pre;color:var(--g)}
.dc-code .line-ref{color:var(--dim);font-size:9px;display:block;margin-bottom:4px}
.bk-row{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:10px}
.bk-dot{width:6px;height:6px;border-radius:1px;flex-shrink:0}
.bk-name{flex:1;color:var(--dim)}
.bk-val{font-variant-numeric:tabular-nums;color:var(--tx)}
.bk-pct{width:40px;text-align:right;color:var(--dim);font-size:9px}
.cs{background:var(--s2);border:1px solid var(--bdr);border-radius:3px;padding:10px 12px;margin-bottom:6px;transition:all .2s;cursor:pointer}
.cs.active{border-color:var(--g);background:rgba(74,222,128,0.04)}
.cs .cs-name{font-size:11px;font-weight:500;margin-bottom:2px}
.cs.active .cs-name{color:var(--g)}
.cs .cs-desc{font-size:9px;color:var(--dim);line-height:1.5}
.cs .cs-code{font-size:9px;color:var(--g);margin-top:4px;font-family:var(--mono);white-space:pre;overflow-x:auto}
.cs .cs-line{font-size:8px;color:var(--dim);margin-top:2px}
</style>
</head>
<body>
<div class="app">
<div class="topbar">
  <a href="./">&larr; KIRI</a>
  <h1>Parameter <em>Architecture</em></h1>
  <div class="modes">
    <button class="on" id="btn-params">Parameters</button>
    <button id="btn-compute">Computation</button>
  </div>
  <a href="live.html">live pass</a>
  <button class="tbtn" id="themeToggle">light</button>
</div>
<div class="main">
  <div class="canvas-wrap">
    <canvas id="c"></canvas>
    <div class="legend">
      <span class="lg"><span class="dot" style="background:#4ade80"></span> Embedding</span>
      <span class="lg"><span class="dot" style="background:#60a5fa"></span> Attention</span>
      <span class="lg"><span class="dot" style="background:#c084fc"></span> MLP</span>
      <span class="lg"><span class="dot" style="background:#fbbf24"></span> Output</span>
    </div>
    <div class="comp-ctrl" id="comp-ctrl" style="display:none">
      <span class="step-lbl" id="step-lbl"></span>
      <button id="btn-prev">&larr;</button>
      <button id="btn-next">&rarr;</button>
      <button id="btn-auto">Auto</button>
    </div>
  </div>
  <div class="info" id="info">
    <h3>Pulse Atom &mdash; 27,840 params</h3>
    <div class="stat-grid">
      <div class="stat"><div class="n">43</div><div class="l">Vocab</div></div>
      <div class="stat"><div class="n">32</div><div class="l">n_embd</div></div>
      <div class="stat"><div class="n">2</div><div class="l">Layers</div></div>
    </div>
    <div id="detail">
      <div class="dc">
        <div class="dc-purpose">Hover or click a parameter block. Drag to orbit, scroll to zoom.</div>
        <div class="dc-code"><span class="line-ref">core/atom.py &mdash; forward() is 34 lines</span>def forward(self, token_id, pos_id, keys, values):
    sd = self.sd
    x = [t + p for t, p in zip(
        sd['wte'][token_id],
        sd['wpe'][pos_id])]
    x = self._rmsnorm(x)
    for li in range(self.n_layer):
        ...  # attention + MLP
    return self._linear(x, sd['lm_head'])</div>
      </div>
    </div>
    <div id="breakdown"></div>
    <div id="comp-steps" style="display:none"></div>
  </div>
</div>
</div>
<script>
// ============================================================
// MODEL DATA
// ============================================================
const TOTAL = 27840;
function ds(n){return n<=16?.45:n<=32?.75:n<=48?.95:.95+Math.log2(n/48)*.55}

// Layout: Q,K,V at one level, Wo above them, f1/f2 side by side
// Flow goes bottom → top (increasing Y)
const C = [
  {id:'wte',    lbl:'wte',    r:43,c:32,  p:1376,t:'Embedding',col:0x4ade80, x:-1.3,y:0,
   purpose:'Token embeddings: maps each of 43 state tokens to a 32-dim vector',
   code:"sd['wte'][token_id]",ln:'atom.py:65'},
  {id:'wpe',    lbl:'wpe',    r:16,c:32,  p:512, t:'Embedding',col:0x4ade80, x:1.3,y:0,
   purpose:'Position embeddings: encodes sequence position (0\u201315)',
   code:"sd['wpe'][pos_id % self.block_size]",ln:'atom.py:65'},

  {id:'l0.wq',  lbl:'L0 Wq',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:-1.6,y:3,
   purpose:'Query projection (Layer 0): "what am I looking for?"',
   code:"q = self._linear(x, sd['l0.wq'])",ln:'atom.py:71'},
  {id:'l0.wk',  lbl:'L0 Wk',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:0,y:3,
   purpose:'Key projection (Layer 0): "what do I contain?"',
   code:"k = self._linear(x, sd['l0.wk'])",ln:'atom.py:72'},
  {id:'l0.wv',  lbl:'L0 Wv',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:1.6,y:3,
   purpose:'Value projection (Layer 0): "what information do I carry?"',
   code:"v = self._linear(x, sd['l0.wv'])",ln:'atom.py:73'},
  {id:'l0.wo',  lbl:'L0 Wo',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:0,y:4.8,
   purpose:'Output projection (Layer 0): combines 4-head attention outputs',
   code:"x = self._linear(xa, sd['l0.wo'])",ln:'atom.py:86'},

  {id:'l0.f1',  lbl:'L0 fc1', r:128,c:32, p:4096,t:'MLP',col:0xc084fc, x:-1.0,y:6.5,
   purpose:'MLP expand (Layer 0): 32 \u2192 128 dims (4\u00D7), then ReLU activation',
   code:"x = self._linear(x, sd['l0.f1'])\nx = [xi.relu() for xi in x]",ln:'atom.py:90-91'},
  {id:'l0.f2',  lbl:'L0 fc2', r:32,c:128, p:4096,t:'MLP',col:0xc084fc, x:1.0,y:6.5,
   purpose:'MLP compress (Layer 0): 128 \u2192 32 dims, back to residual stream',
   code:"x = self._linear(x, sd['l0.f2'])\nx = [a + b for a, b in zip(x, xr)]",ln:'atom.py:92-93'},

  {id:'l1.wq',  lbl:'L1 Wq',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:-1.6,y:9,
   purpose:'Query projection (Layer 1)',
   code:"q = self._linear(x, sd['l1.wq'])",ln:'atom.py:71'},
  {id:'l1.wk',  lbl:'L1 Wk',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:0,y:9,
   purpose:'Key projection (Layer 1)',
   code:"k = self._linear(x, sd['l1.wk'])",ln:'atom.py:72'},
  {id:'l1.wv',  lbl:'L1 Wv',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:1.6,y:9,
   purpose:'Value projection (Layer 1)',
   code:"v = self._linear(x, sd['l1.wv'])",ln:'atom.py:73'},
  {id:'l1.wo',  lbl:'L1 Wo',  r:32,c:32,  p:1024,t:'Attention',col:0x60a5fa, x:0,y:10.8,
   purpose:'Output projection (Layer 1)',
   code:"x = self._linear(xa, sd['l1.wo'])",ln:'atom.py:86'},

  {id:'l1.f1',  lbl:'L1 fc1', r:128,c:32, p:4096,t:'MLP',col:0xc084fc, x:-1.0,y:12.5,
   purpose:'MLP expand (Layer 1): 32 \u2192 128 dims',
   code:"x = self._linear(x, sd['l1.f1'])\nx = [xi.relu() for xi in x]",ln:'atom.py:90-91'},
  {id:'l1.f2',  lbl:'L1 fc2', r:32,c:128, p:4096,t:'MLP',col:0xc084fc, x:1.0,y:12.5,
   purpose:'MLP compress (Layer 1): 128 \u2192 32 dims',
   code:"x = self._linear(x, sd['l1.f2'])\nx = [a + b for a, b in zip(x, xr)]",ln:'atom.py:92-93'},

  {id:'lm_head',lbl:'lm_head',r:43,c:32,  p:1376,t:'Output',col:0xfbbf24, x:0,y:15,
   purpose:'Output projection: 32-dim \u2192 43 logits, then softmax \u2192 P(next token)',
   code:"return self._linear(x, sd['lm_head'])",ln:'atom.py:95'},
];

const compSteps = [
  {name:'Embedding Lookup',act:['wte','wpe'],
   desc:'Look up token and position vectors, add them together',
   code:"x = [t + p for t, p in zip(\n    sd['wte'][token_id],\n    sd['wpe'][pos_id])]\nx = self._rmsnorm(x)",ln:'atom.py:65-66'},
  {name:'L0: Q, K, V Projection',act:['l0.wq','l0.wk','l0.wv'],
   desc:'Project normalized x into query, key, value spaces (3 parallel linear transforms)',
   code:"q = self._linear(x, sd['l0.wq'])\nk = self._linear(x, sd['l0.wk'])\nv = self._linear(x, sd['l0.wv'])",ln:'atom.py:71-73'},
  {name:'L0: Multi-Head Attention',act:['l0.wq','l0.wk','l0.wv','l0.wo'],
   desc:'4 heads: split Q,K,V into 8-dim chunks, compute softmax(Q\u00B7K\u1D40/\u221A8)\u00B7V per head, concat, project through Wo, add residual',
   code:"al = [sum(qh[j]*kh[t][j]\n      for j in range(hd))\n      / hd**0.5\n      for t in range(len(kh))]\naw = self._softmax(al)\nx = self._linear(xa, sd['l0.wo'])\nx = [a+b for a,b in zip(x, xr)]",ln:'atom.py:77-87'},
  {name:'L0: MLP (Feed-Forward)',act:['l0.f1','l0.f2'],
   desc:'RMSNorm \u2192 expand 32\u2192128 \u2192 ReLU \u2192 compress 128\u219232 \u2192 add residual',
   code:"x = self._rmsnorm(x)\nx = self._linear(x, sd['l0.f1'])\nx = [xi.relu() for xi in x]\nx = self._linear(x, sd['l0.f2'])\nx = [a+b for a,b in zip(x, xr)]",ln:'atom.py:89-93'},
  {name:'L1: Q, K, V Projection',act:['l1.wq','l1.wk','l1.wv'],
   desc:'Second layer: same projection, fresh Q,K,V from updated residual stream',
   code:"q = self._linear(x, sd['l1.wq'])\nk = self._linear(x, sd['l1.wk'])\nv = self._linear(x, sd['l1.wv'])",ln:'atom.py:71-73'},
  {name:'L1: Multi-Head Attention',act:['l1.wq','l1.wk','l1.wv','l1.wo'],
   desc:'Second layer attention with KV cache from all previous positions',
   code:"# same attention loop, li=1\nx = self._linear(xa, sd['l1.wo'])\nx = [a+b for a,b in zip(x, xr)]",ln:'atom.py:77-87'},
  {name:'L1: MLP (Feed-Forward)',act:['l1.f1','l1.f2'],
   desc:'Second layer feed-forward: expand, ReLU, compress, residual',
   code:"x = self._linear(x, sd['l1.f1'])\nx = [xi.relu() for xi in x]\nx = self._linear(x, sd['l1.f2'])\nx = [a+b for a,b in zip(x, xr)]",ln:'atom.py:89-93'},
  {name:'Output \u2192 Probabilities',act:['lm_head'],
   desc:'Project 32-dim hidden state to 43 logits (one per vocab token), softmax gives P(next token)',
   code:"return self._linear(x, sd['lm_head'])\n# then: probs = self._softmax(logits)",ln:'atom.py:95'},
];

// ============================================================
// THREE.JS
// ============================================================
const canvas = document.getElementById('c');
const wrap = canvas.parentElement;
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45,1,0.1,200);
const isLI = localStorage.getItem('kiri-theme')==='light';
const renderer = new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setClearColor(isLI?0xf8f8f6:0x06070a);
if(isLI)document.documentElement.classList.add('light');

function resize(){
  const w=wrap.clientWidth,h=wrap.clientHeight;
  camera.aspect=w/h;camera.updateProjectionMatrix();
  renderer.setSize(w,h);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
}
resize();window.addEventListener('resize',resize);

scene.add(new THREE.AmbientLight(0x606080,0.6));
const dl=new THREE.DirectionalLight(0xffffff,0.6);dl.position.set(5,15,10);scene.add(dl);
scene.add(new THREE.DirectionalLight(0x8888ff,0.2)).position.set(-5,5,-5);

// ============================================================
// PARAMETER BLOCKS
// ============================================================
const meshes={},mdata={},allM=[];
C.forEach(c=>{
  const w=ds(c.c),h=ds(c.r),d=0.15;
  const geo=new THREE.BoxGeometry(w,h,d);
  const mat=new THREE.MeshPhysicalMaterial({
    color:c.col,transparent:true,opacity:0.55,
    emissive:new THREE.Color(c.col),emissiveIntensity:0.04,
    metalness:0.1,roughness:0.5,clearcoat:0.3});
  const m=new THREE.Mesh(geo,mat);
  m.position.set(c.x,c.y,0);scene.add(m);
  // wireframe
  m.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo),
    new THREE.LineBasicMaterial({color:c.col,transparent:true,opacity:0.35})));
  // label
  const lc=document.createElement('canvas');lc.width=256;lc.height=48;
  const ctx=lc.getContext('2d');
  ctx.fillStyle='#'+new THREE.Color(c.col).getHexString();
  ctx.font='500 22px monospace';ctx.textAlign='center';
  ctx.fillText(c.lbl,128,28);
  ctx.font='16px monospace';ctx.globalAlpha=0.5;
  ctx.fillText(c.r+'\u00D7'+c.c,128,46);
  const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(lc),transparent:true}));
  sp.scale.set(1.8,0.34,1);sp.position.y=h/2+0.25;m.add(sp);
  meshes[c.id]=m;mdata[c.id]=c;allM.push(m);
  m.userData={cid:c.id};
});

// ============================================================
// ARROWS — curved bezier paths with arrowhead cones
// ============================================================
function arrow(from, to, color, ctrl) {
  const f=new THREE.Vector3(from[0],from[1],from[2]||0);
  const t=new THREE.Vector3(to[0],to[1],to[2]||0);
  let pts;
  if(ctrl){
    const cv=new THREE.QuadraticBezierCurve3(f,new THREE.Vector3(ctrl[0],ctrl[1],ctrl[2]||0),t);
    pts=cv.getPoints(30);
  }else{
    // slight curve via midpoint offset in z for depth
    const mid=new THREE.Vector3((f.x+t.x)/2,(f.y+t.y)/2,0.15);
    const cv=new THREE.QuadraticBezierCurve3(f,mid,t);
    pts=cv.getPoints(20);
  }
  // line
  scene.add(new THREE.Line(
    new THREE.BufferGeometry().setFromPoints(pts),
    new THREE.LineBasicMaterial({color,transparent:true,opacity:0.4})));
  // arrowhead cone
  const dir=new THREE.Vector3().subVectors(pts[pts.length-1],pts[pts.length-3]).normalize();
  const cone=new THREE.Mesh(
    new THREE.ConeGeometry(0.06,0.16,5),
    new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.7}));
  cone.position.copy(t);
  cone.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),dir);
  scene.add(cone);
}

// Helper: get top/bottom edge y of a component
function topY(c){return c.y+ds(c.r)/2+0.08}
function botY(c){return c.y-ds(c.r)/2-0.08}
function cget(id){return C.find(c=>c.id===id)}

// ---- Embeddings → merge point ----
const mergeY = 1.7;
const wte=cget('wte'), wpe=cget('wpe');
arrow([wte.x, topY(wte)], [0, mergeY], 0x4ade80, [-0.5, 1.0, 0.2]);
arrow([wpe.x, topY(wpe)], [0, mergeY], 0x4ade80, [0.5, 1.0, 0.2]);

// ---- Merge → L0 Q, K, V ----
const l0q=cget('l0.wq'), l0k=cget('l0.wk'), l0v=cget('l0.wv'), l0o=cget('l0.wo');
arrow([0, mergeY], [l0q.x, botY(l0q)], 0x60a5fa, [-0.8, 2.3, 0.1]);
arrow([0, mergeY], [l0k.x, botY(l0k)], 0x60a5fa);
arrow([0, mergeY], [l0v.x, botY(l0v)], 0x60a5fa, [0.8, 2.3, 0.1]);

// ---- L0 Q,K,V → Wo (converge upward) ----
arrow([l0q.x, topY(l0q)], [l0o.x, botY(l0o)], 0x60a5fa, [-0.8, 3.9, 0.2]);
arrow([l0k.x, topY(l0k)], [l0o.x, botY(l0o)], 0x60a5fa);
arrow([l0v.x, topY(l0v)], [l0o.x, botY(l0o)], 0x60a5fa, [0.8, 3.9, 0.2]);

// ---- L0 Wo → L0 f1 ----
const l0f1=cget('l0.f1'), l0f2=cget('l0.f2');
arrow([l0o.x, topY(l0o)], [0, 5.7], 0xc084fc);  // wo → merge
arrow([0, 5.7], [l0f1.x, botY(l0f1)], 0xc084fc, [-0.5, 6.0, 0.1]);

// ---- L0 f1 → f2 ----
arrow([l0f1.x+ds(l0f1.c)/2+0.1, l0f1.y], [l0f2.x-ds(l0f2.c)/2-0.1, l0f2.y], 0xc084fc);

// ---- L0 f2 → merge → L1 Q,K,V ----
const merge2Y = 7.8;
arrow([l0f2.x, topY(l0f2)], [0, merge2Y], 0xc084fc, [0.5, 7.3, 0.1]);

const l1q=cget('l1.wq'), l1k=cget('l1.wk'), l1v=cget('l1.wv'), l1o=cget('l1.wo');
arrow([0, merge2Y], [l1q.x, botY(l1q)], 0x60a5fa, [-0.8, 8.4, 0.1]);
arrow([0, merge2Y], [l1k.x, botY(l1k)], 0x60a5fa);
arrow([0, merge2Y], [l1v.x, botY(l1v)], 0x60a5fa, [0.8, 8.4, 0.1]);

// ---- L1 Q,K,V → Wo ----
arrow([l1q.x, topY(l1q)], [l1o.x, botY(l1o)], 0x60a5fa, [-0.8, 9.9, 0.2]);
arrow([l1k.x, topY(l1k)], [l1o.x, botY(l1o)], 0x60a5fa);
arrow([l1v.x, topY(l1v)], [l1o.x, botY(l1o)], 0x60a5fa, [0.8, 9.9, 0.2]);

// ---- L1 Wo → L1 f1 ----
const l1f1=cget('l1.f1'), l1f2=cget('l1.f2');
arrow([l1o.x, topY(l1o)], [0, 11.7], 0xc084fc);
arrow([0, 11.7], [l1f1.x, botY(l1f1)], 0xc084fc, [-0.5, 12.0, 0.1]);

// ---- L1 f1 → f2 ----
arrow([l1f1.x+ds(l1f1.c)/2+0.1, l1f1.y], [l1f2.x-ds(l1f2.c)/2-0.1, l1f2.y], 0xc084fc);

// ---- L1 f2 → lm_head ----
const lmh=cget('lm_head');
arrow([l1f2.x, topY(l1f2)], [lmh.x, botY(lmh)], 0xfbbf24, [0.5, 13.8, 0.1]);

// ---- Layer labels ----
function layerLabel(text,y){
  const lc=document.createElement('canvas');lc.width=256;lc.height=28;
  const ctx=lc.getContext('2d');ctx.fillStyle='#444455';
  ctx.font='400 13px monospace';ctx.textAlign='center';ctx.fillText(text,128,18);
  const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(lc),transparent:true}));
  sp.scale.set(2.8,0.3,1);sp.position.set(-4,y,0);scene.add(sp);
}
layerLabel('EMBEDDINGS',0);
layerLabel('LAYER 0 ATTN',3.5);
layerLabel('LAYER 0 MLP',6.5);
layerLabel('LAYER 1 ATTN',9.5);
layerLabel('LAYER 1 MLP',12.5);
layerLabel('OUTPUT',15);

// ============================================================
// PARTICLES
// ============================================================
const PC=120;
const pGeo=new THREE.BufferGeometry();
const pP=new Float32Array(PC*3),pC=new Float32Array(PC*3);
const pS=[];
for(let i=0;i<PC;i++){
  pS.push({on:false,t:0,from:null,to:null,sp:0.008,col:new THREE.Color(0x4ade80)});
  pP[i*3]=-200;pC[i*3]=.29;pC[i*3+1]=.87;pC[i*3+2]=.5;
}
pGeo.setAttribute('position',new THREE.BufferAttribute(pP,3));
pGeo.setAttribute('color',new THREE.BufferAttribute(pC,3));
scene.add(new THREE.Points(pGeo,new THREE.PointsMaterial({
  size:0.08,vertexColors:true,transparent:true,opacity:0.9,blending:THREE.AdditiveBlending})));

function spawnFlow(fromIds,toIds){
  let n=0;
  for(let i=0;i<PC&&n<15;i++){
    if(!pS[i].on){
      const fi=fromIds[n%fromIds.length],ti=toIds[n%toIds.length];
      const fc=C.find(c=>c.id===fi),tc=C.find(c=>c.id===ti);
      if(!fc||!tc)continue;
      pS[i].on=true;pS[i].t=0;
      pS[i].from=new THREE.Vector3(fc.x+(Math.random()-.5)*.3,fc.y,0);
      pS[i].to=new THREE.Vector3(tc.x+(Math.random()-.5)*.3,tc.y,0);
      pS[i].sp=.006+Math.random()*.008;
      pS[i].col.setHex(tc.col);
      pC[i*3]=pS[i].col.r;pC[i*3+1]=pS[i].col.g;pC[i*3+2]=pS[i].col.b;
      n++;
    }
  }
}

// ============================================================
// CAMERA
// ============================================================
let cTh=0.3,cPh=1.15,cD=24,cTgt=new THREE.Vector3(0,7.5,0);
let drag=false,pmx=0,pmy=0;
canvas.addEventListener('mousedown',e=>{drag=true;pmx=e.clientX;pmy=e.clientY});
window.addEventListener('mouseup',()=>drag=false);
canvas.addEventListener('mousemove',e=>{
  if(!drag)return;
  cTh-=(e.clientX-pmx)*.005;cPh-=(e.clientY-pmy)*.005;
  cPh=Math.max(.2,Math.min(Math.PI-.2,cPh));
  pmx=e.clientX;pmy=e.clientY;
});
canvas.addEventListener('wheel',e=>{cD*=1+e.deltaY*.001;cD=Math.max(8,Math.min(50,cD));e.preventDefault()},{passive:false});
canvas.addEventListener('touchstart',e=>{if(e.touches.length===1){drag=true;pmx=e.touches[0].clientX;pmy=e.touches[0].clientY}},{passive:true});
canvas.addEventListener('touchend',()=>drag=false);
canvas.addEventListener('touchmove',e=>{
  if(!drag||e.touches.length!==1)return;
  cTh-=(e.touches[0].clientX-pmx)*.005;cPh-=(e.touches[0].clientY-pmy)*.005;
  cPh=Math.max(.2,Math.min(Math.PI-.2,cPh));
  pmx=e.touches[0].clientX;pmy=e.touches[0].clientY;
},{passive:true});

// ============================================================
// RAYCASTING
// ============================================================
const rc=new THREE.Raycaster();const mouse=new THREE.Vector2();
let hovId=null,selId=null;
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  mouse.x=((e.clientX-r.left)/r.width)*2-1;
  mouse.y=-((e.clientY-r.top)/r.height)*2+1;
});
canvas.addEventListener('click',()=>{if(hovId){selId=hovId;showDetail(selId)}});

function updateHover(){
  rc.setFromCamera(mouse,camera);
  const h=rc.intersectObjects(allM);
  hovId=h.length>0?h[0].object.userData.cid:null;
  canvas.style.cursor=hovId?'pointer':'grab';
  if(hovId&&!selId)showDetail(hovId);
}

// ============================================================
// INFO PANEL
// ============================================================
function showDetail(id){
  const c=mdata[id];if(!c)return;
  const pct=((c.p/TOTAL)*100).toFixed(1);
  const ch='#'+new THREE.Color(c.col).getHexString();
  document.getElementById('detail').innerHTML=`
    <div class="dc">
      <div class="dc-name" style="color:${ch}">${c.id}</div>
      <div class="dc-shape">${c.r} \u00D7 ${c.c} = ${c.p.toLocaleString()} parameters</div>
      <div class="dc-purpose">${c.purpose}</div>
      <div class="dc-bar">
        <div class="dc-bar-track"><div class="dc-bar-fill" style="width:${pct}%;background:${ch}"></div></div>
        <div class="dc-bar-lbl"><span>${c.t}</span><span>${pct}% of ${TOTAL.toLocaleString()}</span></div>
      </div>
      <div class="dc-code"><span class="line-ref">${c.ln}</span>${c.code}</div>
    </div>`;
}

function renderBreakdown(){
  const g={};
  C.forEach(c=>{if(!g[c.t])g[c.t]={p:0,col:c.col,n:0};g[c.t].p+=c.p;g[c.t].n++});
  let h='<h3 style="margin-top:0">Parameter Breakdown</h3>';
  for(const[t,v]of Object.entries(g)){
    const pct=((v.p/TOTAL)*100).toFixed(1);
    const ch='#'+new THREE.Color(v.col).getHexString();
    h+=`<div class="bk-row"><span class="bk-dot" style="background:${ch}"></span>
      <span class="bk-name">${t} (${v.n})</span><span class="bk-val">${v.p.toLocaleString()}</span>
      <span class="bk-pct">${pct}%</span></div>`;
  }
  document.getElementById('breakdown').innerHTML=h;
}
renderBreakdown();

// ============================================================
// MODE SWITCHING
// ============================================================
let mode='params',cStep=0,cPlay=false,cInt=null;
document.getElementById('btn-params').addEventListener('click',()=>setMode('params'));
document.getElementById('btn-compute').addEventListener('click',()=>setMode('compute'));

function setMode(m){
  mode=m;
  document.getElementById('btn-params').classList.toggle('on',m==='params');
  document.getElementById('btn-compute').classList.toggle('on',m==='compute');
  document.getElementById('comp-ctrl').style.display=m==='compute'?'flex':'none';
  document.getElementById('breakdown').style.display=m==='params'?'block':'none';
  document.getElementById('comp-steps').style.display=m==='compute'?'block':'none';
  if(m==='compute'){cStep=0;selId=null;renderCS();applyCS();}
  else{if(cPlay)toggleCP();resetApp();
    document.getElementById('detail').innerHTML=`<div class="dc">
      <div class="dc-purpose">Hover or click a parameter block to see details.</div>
      <div class="dc-code"><span class="line-ref">core/atom.py \u2014 forward() is 34 lines</span>def forward(self, token_id, pos_id, keys, values):
    sd = self.sd
    x = [t + p for t, p in zip(
        sd['wte'][token_id],
        sd['wpe'][pos_id])]
    x = self._rmsnorm(x)
    for li in range(self.n_layer):
        ...  # attention + MLP
    return self._linear(x, sd['lm_head'])</div></div>`;}
}

function resetApp(){C.forEach(c=>{const m=meshes[c.id];m.material.opacity=0.55;m.material.emissiveIntensity=0.04})}

function applyCS(){
  const s=compSteps[cStep];
  const act=new Set(s.act);
  C.forEach(c=>{
    const m=meshes[c.id];
    m.material.opacity=act.has(c.id)?0.85:0.15;
    m.material.emissiveIntensity=act.has(c.id)?0.25:0.01;
  });
  document.getElementById('step-lbl').textContent=`${cStep+1}/${compSteps.length}: ${s.name}`;
  // spawn particles from previous to current
  if(cStep>0){const prev=compSteps[cStep-1].act;if(prev.length&&s.act.length)spawnFlow(prev,s.act)}
  // detail
  document.getElementById('detail').innerHTML=`<div class="dc">
    <div class="dc-name" style="color:var(--g)">${s.name}</div>
    <div class="dc-purpose">${s.desc}</div>
    <div class="dc-code"><span class="line-ref">${s.ln}</span>${s.code}</div>
    <div class="dc-bar"><div class="dc-bar-track"><div class="dc-bar-fill" style="width:${(cStep+1)/compSteps.length*100}%;background:var(--g)"></div></div>
    <div class="dc-bar-lbl"><span>Step ${cStep+1}</span><span>${compSteps.length} total</span></div></div></div>`;
  renderCS();
}

function renderCS(){
  const el=document.getElementById('comp-steps');
  let h='<h3 style="margin-top:0">Forward Pass Steps</h3>';
  compSteps.forEach((s,i)=>{
    h+=`<div class="cs${i===cStep?' active':''}" data-i="${i}">
      <div class="cs-name">${s.name}</div>
      <div class="cs-desc">${s.desc}</div>
      <div class="cs-code">${s.code}</div>
      <div class="cs-line">${s.ln}</div></div>`;
  });
  el.innerHTML=h;
  el.querySelectorAll('.cs').forEach(e=>e.addEventListener('click',()=>{cStep=parseInt(e.dataset.i);applyCS()}));
  const ae=el.querySelector('.cs.active');if(ae)ae.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function csNext(){cStep=(cStep+1)%compSteps.length;applyCS()}
function csPrev(){cStep=(cStep-1+compSteps.length)%compSteps.length;applyCS()}
function toggleCP(){
  cPlay=!cPlay;const b=document.getElementById('btn-auto');
  if(cPlay){b.classList.add('on');b.textContent='Pause';cInt=setInterval(csNext,2200)}
  else{b.classList.remove('on');b.textContent='Auto';clearInterval(cInt)}
}
document.getElementById('btn-next').addEventListener('click',csNext);
document.getElementById('btn-prev').addEventListener('click',csPrev);
document.getElementById('btn-auto').addEventListener('click',toggleCP);

// ============================================================
// THEME
// ============================================================
const tb=document.getElementById('themeToggle');
if(isLI)tb.textContent='dark';
tb.addEventListener('click',()=>{
  document.documentElement.classList.toggle('light');
  const l=document.documentElement.classList.contains('light');
  tb.textContent=l?'dark':'light';
  localStorage.setItem('kiri-theme',l?'light':'dark');
  renderer.setClearColor(l?0xf8f8f6:0x06070a);
});

// ============================================================
// ANIMATE
// ============================================================
let time=0;
function animate(){
  requestAnimationFrame(animate);time+=0.016;
  camera.position.x=cTgt.x+cD*Math.sin(cPh)*Math.sin(cTh);
  camera.position.y=cTgt.y+cD*Math.cos(cPh);
  camera.position.z=cTgt.z+cD*Math.sin(cPh)*Math.cos(cTh);
  camera.lookAt(cTgt);
  C.forEach((c,i)=>{meshes[c.id].position.y=c.y+Math.sin(time*.6+i*.4)*.03});
  // particles
  for(let i=0;i<PC;i++){
    const p=pS[i];if(!p.on){pP[i*3]=-200;continue}
    p.t+=p.sp;if(p.t>1){p.on=false;pP[i*3]=-200;continue}
    const e=p.t<.5?2*p.t*p.t:1-Math.pow(-2*p.t+2,2)/2;
    pP[i*3]=p.from.x+(p.to.x-p.from.x)*e+Math.sin(p.t*Math.PI*3)*.12;
    pP[i*3+1]=p.from.y+(p.to.y-p.from.y)*e;
    pP[i*3+2]=Math.cos(p.t*Math.PI*2)*.12;
  }
  pGeo.attributes.position.needsUpdate=true;pGeo.attributes.color.needsUpdate=true;
  // hover (params mode)
  if(mode==='params'){
    updateHover();
    C.forEach(c=>{
      const m=meshes[c.id];
      if(c.id===selId){m.material.opacity=0.85;m.material.emissiveIntensity=0.2}
      else if(c.id===hovId){m.material.opacity=0.75;m.material.emissiveIntensity=0.15}
      else{m.material.opacity=0.55;m.material.emissiveIntensity=0.04}
    });
  }
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
